rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Role Checks
    function hasRole(roleName) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == roleName;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isModerator() {
      return hasRole('moderator') || isAdmin();
    }

    // Lifecycle Checks
    function isNotSuspended() {
      let status = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status;
      return status != 'suspended' && status != 'deleted';
    }

    function isAgeVerified(userId) {
       return get(/databases/$(database)/documents/users/$(userId)).data.ageVerified == true;
    }
    
    // --- USERS ---
    match /users/{userId} {
      // Read: Owner or Admin
      allow get: if isOwner(userId) || isAdmin();
      
      // Create: Owner (Self-Registration)
      allow create: if isOwner(userId); 
      
      // Update: Owner can update profile, BUT NOT role or status
      allow update: if isOwner(userId) 
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLogin', 'consentVersion', 'ageVerified', 'isAnonymous'])
                    && isNotSuspended();
                    
      // Admin Update: Can update EVERYTHING (Role, Status)
      allow update: if isAdmin();
      
      // Entitlements
      match /entitlements/wallet {
        allow read: if isOwner(userId);
        allow write: if false; // Backend only
      }
    }

    // --- JOBS ---
    match /jobs/{jobId} {
      // Create: Auth + Age Verified + Not Suspended
      allow create: if isAuthenticated() 
                    && request.resource.data.creatorId == request.auth.uid
                    && isAgeVerified(request.auth.uid)
                    && isNotSuspended();
      
      // Read: Creator or Moderator
      allow read: if resource.data.creatorId == request.auth.uid || isModerator();
      
      allow update: if false;
    }

    // --- ASSETS (Library) ---
    match /assets/{assetId} {
      // Read: Owner or Moderator (if needed for review)
      allow read: if resource.data.ownerId == request.auth.uid || (isModerator() && false); // Strict Privacy: Mods usually don't see assets unless flaged. Keeping False for now.
      
      allow create, update: if false;
      allow delete: if false;
    }

    // --- MODERATION FLAGS ---
    match /moderation_flags/{flagId} {
       allow create: if isAuthenticated();
       allow read, update: if isModerator();
    }
    
    // --- AUDIT LOGS ---
    match /audit_logs/{logId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAdmin();
    }
  }
}
